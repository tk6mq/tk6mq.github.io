<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#f5f5f5" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#121212" media="(prefers-color-scheme: dark)">
    <title>Fixed Counter</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- テーマ変数 --- */
        :root {
            --bg-color: #f0f2f5;
            --text-color: #333;
            --panel-bg: rgba(255, 255, 255, 0.95);
            --shadow-color: rgba(0,0,0,0.15);
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #121212;
                --text-color: #eee;
                --panel-bg: rgba(30, 30, 30, 0.95);
                --shadow-color: rgba(0,0,0,0.5);
            }
        }

        /* --- 全体設定 --- */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            /* 横揺れ防止 */
            overflow-x: hidden;
            /* ダブルタップによるズーム防止（スマホ対応） */
            touch-action: manipulation; 
            padding-top: 80px;
            padding-bottom: 50px;
        }

        /* --- メニューバー --- */
        .app-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: var(--panel-bg);
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 8px var(--shadow-color);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            z-index: 1000;
        }

        .menu-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
            overflow: hidden; /* リップル用 */
        }
        .menu-btn i { font-size: 1.1rem; }

        /* --- カウンター配置エリア --- */
        #counter-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 25px;
            width: 100%;
            max-width: 1200px;
            padding: 20px;
        }

        /* --- 丸いカウンター本体（サイズ固定） --- */
        .circle-counter {
            position: relative;
            /* ★固定サイズ */
            width: 200px;
            height: 200px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            user-select: none;
            box-shadow: 0 6px 15px var(--shadow-color);
            cursor: pointer;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            /* 色の変化のみアニメーション */
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275), background-color 0.3s;
        }

        /* タップ時のへこみアクション（サイズは変わらないが押した感は出す） */
        .circle-counter:active {
            transform: scale(0.95);
        }

        /* 中身の要素 */
        .counter-inner {
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            pointer-events: none; /* 親のクリックを優先 */
        }

        /* 要素ごとにクリックを有効化 */
        .counter-name, .actions, .tool-btn {
            pointer-events: auto;
        }

        .counter-name {
            font-size: 0.9rem;
            margin-bottom: 5px;
            border-bottom: 1px dotted rgba(255,255,255,0.6);
            cursor: pointer;
            max-width: 80%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .count-display {
            font-size: 3.5rem;
            font-weight: 800;
            margin: 0;
            line-height: 1.1;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* --- アクションボタン群 --- */
        .actions {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .action-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.6);
            background: rgba(0,0,0,0.1);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.2s;
        }
        .action-btn:active { background: rgba(255,255,255,0.3); }

        /* --- ツールボタン（削除・色） --- */
        /* 色変更ボタンを <label> に変更してinputを内包させる（スマホ対応の定石） */
        .tool-btn {
            position: absolute;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(0,0,0,0.2);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10;
            transition: background 0.2s;
            border: none; /* buttonタグの場合のリセット */
            font-size: 1rem;
        }
        .tool-btn:active { background: rgba(0,0,0,0.4); }
        
        .btn-delete { top: 15%; right: 15%; }
        /* 左上の色変更ボタン */
        .btn-color { top: 15%; left: 15%; }

        /* カラーピッカー自体は見えなくするが、タップ判定は残す */
        .color-picker-hidden {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* --- リップルエフェクト --- */
        .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple-anim 0.5s linear;
            background-color: rgba(255, 255, 255, 0.4);
            pointer-events: none;
        }
        @keyframes ripple-anim {
            to { transform: scale(3); opacity: 0; }
        }

    </style>
</head>
<body>

    <nav class="app-bar">
        <button class="menu-btn" onclick="addCounterWithRipple(event)">
            <i class="fas fa-plus"></i> 追加
        </button>
        <button class="menu-btn" onclick="exportCSVWithRipple(event)">
            <i class="fas fa-file-csv"></i> Excel
        </button>
        <button class="menu-btn" onclick="resetAllWithRipple(event)">
            <i class="fas fa-trash-alt"></i> リセット
        </button>
    </nav>

    <div id="counter-container"></div>

    <script>
        // 設定（固定サイズ）
        const FIXED_SIZE = 200;

        let counters = [];

        window.onload = () => {
            const saved = localStorage.getItem('fixedCounterData');
            if (saved) {
                counters = JSON.parse(saved);
            } else {
                addCounter();
            }
            render();
        };

        function saveData() {
            localStorage.setItem('fixedCounterData', JSON.stringify(counters));
        }

        function getRandomColor() {
            const colors = ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#009688', '#4CAF50', '#FF9800', '#FF5722', '#607D8B'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // --- リップル生成 ---
        function createRipple(event, element) {
            const circle = document.createElement("span");
            const diameter = Math.max(element.clientWidth, element.clientHeight);
            const radius = diameter / 2;
            const rect = element.getBoundingClientRect();
            
            const clientX = event.touches ? event.touches[0].clientX : event.clientX;
            const clientY = event.touches ? event.touches[0].clientY : event.clientY;

            // タップ位置計算
            const x = (clientX ? clientX : rect.left + radius) - rect.left - radius;
            const y = (clientY ? clientY : rect.top + radius) - rect.top - radius;

            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${x}px`;
            circle.style.top = `${y}px`;
            circle.classList.add("ripple");

            const existing = element.getElementsByClassName("ripple")[0];
            if (existing) existing.remove();
            
            element.appendChild(circle);
        }

        // --- 操作系 ---
        function addCounterWithRipple(e) { createRipple(e, e.currentTarget); addCounter(); }
        function exportCSVWithRipple(e) { createRipple(e, e.currentTarget); exportCSV(); }
        function resetAllWithRipple(e) { createRipple(e, e.currentTarget); resetAll(); }

        function addCounter() {
            counters.push({
                id: Date.now(),
                name: `項目 ${counters.length + 1}`,
                count: 0,
                color: getRandomColor()
            });
            saveData();
            render();
            // スムーズスクロール
            setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 100);
        }

        // 丸ごとのクリック（カウントアップ）
        function handleMainClick(e, id) {
            createRipple(e, e.currentTarget);
            const item = counters.find(c => c.id === id);
            if(item) {
                item.count++;
                saveData();
                render();
                if(navigator.vibrate) navigator.vibrate(25);
            }
        }

        function decreaseCount(e, id) {
            e.stopPropagation(); // 親のイベントを止める
            createRipple(e, e.currentTarget);
            const item = counters.find(c => c.id === id);
            if(item) {
                item.count--;
                saveData();
                render();
                if(navigator.vibrate) navigator.vibrate(15);
            }
        }

        function editValue(e, id) {
            e.stopPropagation();
            createRipple(e, e.currentTarget);
            const item = counters.find(c => c.id === id);
            let val = prompt("数値を入力してください", item.count);
            if(val !== null && !isNaN(val) && val.trim() !== "") {
                item.count = parseInt(val);
                saveData();
                render();
            }
        }

        function editName(e, id) {
            e.stopPropagation();
            const item = counters.find(c => c.id === id);
            let name = prompt("項目名を変更", item.name);
            if(name && name.trim() !== "") {
                item.name = name;
                saveData();
                render();
            }
        }

        function deleteCounter(e, id) {
            e.stopPropagation();
            if(confirm('削除しますか？')) {
                counters = counters.filter(c => c.id !== id);
                saveData();
                render();
            }
        }

        // 色変更（直接inputのchangeイベントで処理）
        function updateColor(id, hex) {
            const item = counters.find(c => c.id === id);
            if(item) {
                item.color = hex;
                saveData();
                render();
            }
        }

        // カラーピッカークリック時のイベント伝播阻止（親のクリック反応防止）
        function preventBubble(e) {
            e.stopPropagation();
        }

        function exportCSV() {
            let csv = "\uFEFF項目名,カウント,色\n";
            counters.forEach(c => csv += `${c.name},${c.count},${c.color}\n`);
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv;charset=utf-8;'}));
            link.download = `Count_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        function resetAll() {
            if(confirm('全データをリセットしますか？')) {
                counters = [];
                addCounter();
                saveData();
                render();
            }
        }

        // --- 描画処理 ---
        function render() {
            const container = document.getElementById('counter-container');
            container.innerHTML = '';

            counters.forEach(item => {
                const div = document.createElement('div');
                div.className = 'circle-counter';
                // サイズはCSSで固定(200px)されているため、JSでのサイズ指定は削除
                div.style.backgroundColor = item.color;
                
                // 丸全体のクリックイベント
                div.onclick = (e) => handleMainClick(e, item.id);

                div.innerHTML = `
                    <label class="tool-btn btn-color" onclick="preventBubble(event)">
                        <i class="fas fa-palette"></i>
                        <input type="color" class="color-picker-hidden" 
                               value="${item.color}" onchange="updateColor(${item.id}, this.value)">
                    </label>

                    <button class="tool-btn btn-delete" onclick="deleteCounter(event, ${item.id})">
                        <i class="fas fa-times"></i>
                    </button>
                    
                    <div class="counter-inner">
                        <div class="counter-name" onclick="editName(event, ${item.id})">${item.name}</div>
                        
                        <div class="count-display">
                             ${item.count}
                        </div>
                        
                        <div class="actions">
                            <button class="action-btn" onclick="decreaseCount(event, ${item.id})">
                                <i class="fas fa-minus"></i>
                            </button>
                            
                            <button class="action-btn" onclick="editValue(event, ${item.id})">
                                <i class="fas fa-keyboard"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
    </script>
</body>
</html>